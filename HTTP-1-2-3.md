## HTTP1.1 与 HTTP2

### HTTP1.1的缺陷

1. 高延迟 -- 队头阻塞
2. 无状态特性 -- 阻碍交互
3. 明文传输 -- 不安全性
4. 不支持服务端推送

#### 队头阻塞

队头阻塞是指当顺序发送的请求序列中的一个请求因为某种原因被阻塞时，在后面排队的所有请求也一并被阻塞，会导致客户端迟迟收不到数据。

#### 无状态特性

无状态是指协议对于连接状态没有**记忆能力**。纯净的HTTP是没有cookie等机制的，每一个连接都是一个新的连接。上次请求验证了用户名密码，而下一次请求服务器并不知道它与上一条请求有何关联，就是**掉登录态。**

#### 不安全性

传输内容没有加密，中途可能被篡改和劫持。

### SPDY协议

SPDY 是由 google 推行的改进版本的 HTTP1.1 （那时候还没有 HTTP2）。

![img](https://pic4.zhimg.com/80/v2-7afd90538135334355eff37cdd34e4fb_720w.jpg)

特性：

1. 多路复用 -- 解决队头阻塞
2. 头部压缩 -- 解决巨大的HTTP头部
3. 请求优先级 -- 先获取重要数据
4. 服务端推送 -- 填补空缺
5. 提高安全性

#### 多路复用

SPDY 允许在一个连接上无限制并发流。因为请求在一个通道上，TCP 效率更高（参考 [TCP 拥塞控制](https://zhuanlan.zhihu.com/p/37379780) 中的**慢启动**）。更少的网络连接，发出更密集的包。

#### 头部压缩

使用专门的 HPACK 算法，每次请求和响应只发送差异头部，一般可以达到 50%~90% 的高压缩率。

#### 请求优先级

虽然无限的并发流解决了队头阻塞的问题，但如果带宽受限，客户端可能会因防止堵塞通道而阻止请求。在网络通道被非关键资源堵塞时，高优先级的请求会被优先处理。

#### 服务端推送

[服务端推送]( http://www.ruanyifeng.com/blog/2018/03/http2_server_push.html)，可以让服务端主动把资源文件推送给客户端。当然客户端也有权利选择是否接收。

#### 提高安全性

支持使用HTTPS进行加密传输。

### HTTP2

> HTTP2基于SPDY，专注于性能，最大的一个目标是在用户和网站间只用一个连接。

新增特性：

1. 二进制分帧 -- HTTP性能增加的核心
2. 多路复用 -- 解决串行的文件传输和连接数过多

#### 二进制分帧

首先，HTTP2 没有改变 HTTP1 的语义，只是在应用层使用二进制分帧方式传输。因此，也引入了新的通信单位：**帧、消息、流**。

分帧有什么好处？服务器单位时间接收到的请求数变多，可以提高并发数。最重要的是，为多路复用提供了底层支持。

#### 多路复用

一个域名对应一个连接，一个流代表了一个完整的**请求-响应**过程。**帧**是最小的数据单位，每个**帧**会标识出该帧属于哪个**流**，**流**也就是多个帧组成的数据流。多路复用，就是在一个 TCP 连接中可以存在多个流。[演示](https://link.zhihu.com/?target=https%3A//http2.akamai.com/demo)

### HTTP2的缺陷

1. TCP以及TCP+TLS建立连接的延时
2. TCP的队头阻塞没有彻底解决
3. 多路复用导致服务器压力上升
4. 多路复用容易Timeout

#### 建立连接

TCP 连接需要和服务器进行**三次握手**，即消耗完 1.5 个 RTT 之后才能进行数据传输。

TLS 连接有两个版本—— TLS1.2 和 TLS1.3，每个版本建立连接所花的时间不同，大致需要 1~2 个 RTT。	     

RTT（Round-Trip Time）:
            往返时延。表示从发送端发送数据开始，到发送端收到来自接收端的确认（接收端收到数据后便立即发送    确认），总共经历的时延。

#### 队头阻塞没有彻底解决

TCP 为了保证可靠传输，有一个“超时重传”机制，丢失的包必须等待重传确认。HTTP2 出现丢包时，整个 TCP 都要等待重传，那么就会阻塞该 TCP 连接中的所有请求。

#### 多路复用导致服务器压力上升

多路复用没有限制同时请求数。请求的平均数量与往常相同，但实际会有许多请求的短暂爆发，导致瞬时 QPS 暴增。

#### **多路复用容易 Timeout**

大批量的请求同时发送，由于 HTTP2 连接内存在多个并行的流，而网络带宽和服务器资源有限，每个流的资源会被稀释，虽然它们开始时间相差更短，但却都可能超时。

## HTTP3

### QUIC

> Google在推 SPDY 的时候就已经意识到了这些问题，于是就另起炉灶搞了一个基于 UDP 协议的 QUIC 协议。而这个就是 HTTP3。它真正“完美”地解决了“队头阻塞”问题。 



 ![img](https://pic2.zhimg.com/80/v2-042349861ba29fc613bd2364bb3f3881_720w.jpg) 



#### 主要特点

1. 改进的拥塞控制、可靠传输
2. 快速握手
3. 集成了TLS1.3加密
4. 多路复用
5. 连接迁移

#### 



参考文章： https://zhuanlan.zhihu.com/p/102561034 

